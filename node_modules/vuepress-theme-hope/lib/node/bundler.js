"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.updateBundlerOptions = exports.checkTag = void 0;
const vuepress_shared_1 = require("@mr-hope/vuepress-shared");
const encrypt_1 = require("./encrypt");
/**
 * Add tags as customElement
 *
 * @param app VuePress Node App
 * @param customElements tags recognized as custom element
 */
const checkTag = (app) => {
    const { bundler, bundlerConfig } = app.options;
    // for vite
    if (bundler.endsWith("vite")) {
        const viteBundlerConfig = bundlerConfig;
        if (!viteBundlerConfig.vuePluginOptions)
            viteBundlerConfig.vuePluginOptions = {};
        if (!viteBundlerConfig.vuePluginOptions.template)
            viteBundlerConfig.vuePluginOptions.template = {};
        if (!viteBundlerConfig.vuePluginOptions.template.compilerOptions)
            viteBundlerConfig.vuePluginOptions.template.compilerOptions = {};
        const { isCustomElement } = viteBundlerConfig.vuePluginOptions.template.compilerOptions;
        viteBundlerConfig.vuePluginOptions.template.compilerOptions.isCustomElement =
            (tag) => {
                if (isCustomElement) {
                    const result = isCustomElement(tag);
                    if (!result)
                        (0, vuepress_shared_1.tagHint)(tag, app.env.isDebug);
                    return result;
                }
                (0, vuepress_shared_1.tagHint)(tag, app.env.isDebug);
            };
    }
    // for webpack
    if (bundler.endsWith("webpack")) {
        const webpackBundlerConfig = bundlerConfig;
        if (!webpackBundlerConfig.vue)
            webpackBundlerConfig.vue = {};
        if (!webpackBundlerConfig.vue.compilerOptions)
            webpackBundlerConfig.vue.compilerOptions = {};
        const { isCustomElement } = webpackBundlerConfig.vue.compilerOptions;
        webpackBundlerConfig.vue.compilerOptions.isCustomElement = (tag) => {
            if (isCustomElement) {
                const result = isCustomElement(tag);
                if (!result)
                    (0, vuepress_shared_1.tagHint)(tag, app.env.isDebug);
                return result;
            }
            (0, vuepress_shared_1.tagHint)(tag, app.env.isDebug);
        };
    }
};
exports.checkTag = checkTag;
const updateBundlerOptions = (app) => {
    (0, vuepress_shared_1.addViteOptimizeDepsInclude)(app, [
        "@vueuse/core",
        "bcryptjs",
        "lodash.throttle",
    ]);
    if (app.env.isDev)
        (0, vuepress_shared_1.addViteOptimizeDepsInclude)(app, [
            "@mr-hope/vuepress-shared/lib/client",
            "dayjs",
            "dayjs/plugin/localizedFormat",
            "dayjs/plugin/objectSupport",
            "dayjs/plugin/timezone",
            "dayjs/plugin/utc",
        ]);
    (0, vuepress_shared_1.addViteSsrNoExternal)(app, [
        "@mr-hope/vuepress-shared",
        "vuepress-theme-hope",
    ]);
    (0, vuepress_shared_1.addViteOptimizeDepsExclude)(app, "vuepress-theme-hope");
    (0, exports.checkTag)(app);
    (0, encrypt_1.handleCrytoForWebpack)(app);
};
exports.updateBundlerOptions = updateBundlerOptions;
//# sourceMappingURL=bundler.js.map